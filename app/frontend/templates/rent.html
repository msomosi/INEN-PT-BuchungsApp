<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Buchungsmanagement-System</title>
    <style>
        /* Allgemeiner Stil */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .map-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }

        #map { height: 400px; }

        h1 {
            color: #333;
            text-align: center;
        }

        form label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }

        form input,
        form button {
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
        }

        form button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            border: none;
        }

        form button:hover {
            background-color: #1d78b5;
        }

        #book-btn {
            background-color: #3498db;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none; /* Anfangs versteckt */
            width: 100%;
            margin-top: 20px;
            border: none;
            cursor: pointer;
        }

        #book-btn:hover {
            background-color: #1d78b5;
        }

        .result-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s ease;
            cursor: pointer;
        }

        .result-item:hover {
            background-color: #f0f8ff;
        }

        .result-item.selected {
            background-color: #d4edda; /* Markiere ausgewähltes Element */
            border-color: #c3e6cb;
        }

        .result-info {
            flex-grow: 1;
            padding-right: 10px;
        }

        .logo-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .logo-container img {
            width: 300px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .map-container {
                height: 300px;
            }

            .logo-container img {
                width: 300px;
            }
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
</head>
<body>
    <div class="logo-container">
        <img src="https://hochschule-burgenland.at/typo3conf/ext/website_template/Resources/Public/Images/Logos/Bgld_FH_Logo_RGB.jpg" alt="Logo">
    </div>

    <div class="container">
        <!-- Anbieter-Suche -->
        <div class="form-section">
            <h1>Start your booking ..</h1>
            <form id="search-form">
                <label for="location">Ort:</label>
                <input type="text" id="location" name="location" placeholder="Ort eingeben (optional)">

                <label for="radius">Radius (in km):</label>
                <input type="number" id="radius" name="radius" value="10" min="1">

                <label for="start_date">Startdatum:</label>
                <input type="date" id="start_date" required onchange="validateSearch()">

                <label for="end_date">Enddatum:</label>
                <input type="date" id="end_date" required onchange="validateSearch()">

                <label for="days">Anzahl der Nächte:</label>
                <input type="number" id="days" readonly>

                <button type="button" id="search-btn" onclick="searchProviders()">Unterkunft finden</button>
            </form>
        </div>

        <!-- Ergebnisse -->
        <div id="results-section" style="display: none;">
            <h2>Verfügbare Unterkunft:</h2>
            <ul id="provider-list"></ul>
            <button id="book-btn" onclick="bookRoom()">Buchen</button>
        </div>

        <!-- Karte -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script>
        let map;
        let markers = [];
        let selectedProvider = null;
        let radiusCircle = null;

        // Zieladresse der Hochschule Burgenland
        const destinationLocation = {
            name: "Hochschule Burgenland",
            address: "Campus 1, 7000 Eisenstadt",
            lat: 47.82948485,
            lng: 16.534787097735926,
            isDestination: true
        };

        document.addEventListener("DOMContentLoaded", () => {
            initializeDateSelection();
            initializeMap();
        });

        function highlightHotelOnMap(lat, lng, hotelName) {
            const hotelMarker = L.marker([lat, lng])
                .addTo(map)
                .bindPopup(`<b>${hotelName}</b>`)
                .openPopup();

            // Zoomen auf den Marker und die Hochschule Burgenland
            const bounds = L.latLngBounds([
                [destinationLocation.lat, destinationLocation.lng],
                [lat, lng]
            ]);
            map.fitBounds(bounds, { padding: [100, 100] });
        }

        function initializeDateSelection() {
            const fromDateInput = document.getElementById("start_date");
            const toDateInput = document.getElementById("end_date");

            // Finde den nächsten Freitag und Samstag
            const today = new Date();
            let nextFriday = new Date(today);
            let nextSaturday = new Date(today);

            nextFriday.setDate(today.getDate() + ((5 - today.getDay() + 7) % 7));
            nextSaturday.setDate(nextFriday.getDate() + 1);

            // Formatierung als yyyy-mm-dd
            const formatDate = (date) => date.toISOString().split("T")[0];

            fromDateInput.value = formatDate(nextFriday);
            toDateInput.value = formatDate(nextSaturday);
        }

        function initializeMap() {
            map = L.map('map').setView([47.8294849, 16.5347871], 13);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
        }

        function showRadiusCircle(center, radius) {
            if (radiusCircle) map.removeLayer(radiusCircle);
            const radiusInMeters = radius * 1000;
            radiusCircle = L.circle(center, {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.1,
                radius: radiusInMeters
            }).addTo(map);
            map.setView(center, 11);
        }

        async function searchProviders() {
            const location = document.getElementById('location').value || 'FH Burgenland';
            const radius = parseFloat(document.getElementById('radius').value);
            const center = [47.8294849, 16.5347871];
            showRadiusCircle(center, radius);

            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;

            const response = await fetch(`/search-providers?location=${location}&radius=${radius}&start_date=${startDate}&end_date=${endDate}`);
            const providers = await response.json();

            const providerList = document.getElementById('provider-list');
            providerList.innerHTML = '';
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (!providers || providers.length === 0) {
                providerList.innerHTML = '<li>Keine Anbieter gefunden.</li>';
                document.getElementById('results-section').style.display = 'block';
                return;
            }

            providers.forEach((provider) => {
                const li = document.createElement('li');
                li.className = 'result-item';
                li.innerHTML = `
                    <div class="result-info">
                        <strong>${provider.name}</strong> (${provider.type}) - ${provider.distance} km entfernt
                        <br>Adresse: ${provider.address}
                        <br>Parkplatz: ${provider.parking.available ? 'Verfügbar' : 'Nicht verfügbar'}
                    </div>
                `;
                li.addEventListener('click', () => {
                    selectProvider(provider, li);
                    highlightHotelOnMap(provider.location[0], provider.location[1], provider.name);
                });
                providerList.appendChild(li);

                addMarker(provider.location[0], provider.location[1], provider.name);
            });

            document.getElementById('results-section').style.display = 'block';
        }

        function selectProvider(provider, listItem) {
            selectedProvider = provider;
            document.querySelectorAll('.result-item').forEach(item => item.classList.remove('selected'));
            listItem.classList.add('selected');
            document.getElementById('book-btn').style.display = 'block';

            // Entferne den Radiuskreis beim Auswählen eines Anbieters
            if (radiusCircle) {
                map.removeLayer(radiusCircle);
            }
            map.setView(provider.location, 16);
        }

        function addMarker(lat, lon, name) {
            const marker = L.marker([lat, lon]).addTo(map).bindPopup(name);
            markers.push(marker);
        }

        function bookRoom() {
            if (selectedProvider) {
                alert(`Buchung erfolgreich für: ${selectedProvider.name}`);
            }
        }

        function validateSearch() {
            const startDate = new Date(document.getElementById('start_date').value);
            const endDate = new Date(document.getElementById('end_date').value);

            if (startDate && endDate && endDate > startDate) {
                const days = (endDate - startDate) / (1000 * 3600 * 24);
                document.getElementById('days').value = days;
                document.getElementById('search-btn').disabled = false;
            } else {
                document.getElementById('days').value = '';
                document.getElementById('search-btn').disabled = true;
            }
        }
    </script>
</body>
</html>
